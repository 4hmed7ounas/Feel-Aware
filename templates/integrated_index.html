<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Feel-Aware System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin-top: 30px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #6c5ce7;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #6c5ce7;
            border-color: #6c5ce7;
        }
        .btn-primary:hover {
            background-color: #5b4bc7;
            border-color: #5b4bc7;
        }
        .btn-danger {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        .emotion-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .happy-color { background-color: #f1c40f; }
        .sad-color { background-color: #3498db; }
        .angry-color { background-color: #e74c3c; }
        .neutral-color { background-color: #95a5a6; }
        .error-color { background-color: #7f8c8d; }
        
        .chat-container {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 10px;
        }
        .user-message {
            background-color: #dcf8c6;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 80%;
            align-self: flex-end;
            margin-left: auto;
        }
        .ai-message {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 80%;
        }
        .recording-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        .tone-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            margin-right: 5px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .tone-calm {
            background-color: #3498db;
            color: white;
        }
        .tone-cheerful {
            background-color: #f1c40f;
            color: #333;
        }
        .tone-neutral {
            background-color: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Integrated Feel-Aware System</h1>
        <p class="text-center mb-4">AI Voice Emotion Detection with Gemini Response Generation and ElevenLabs Voice Synthesis</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        System Control
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <button id="startBtn" class="btn btn-primary">Start System</button>
                            <button id="stopBtn" class="btn btn-danger" disabled>Stop System</button>
                        </div>
                        <div class="alert alert-info" id="systemStatus">
                            System is not running. Click "Start System" to begin.
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        Voice Input
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <button id="recordBtn" class="btn btn-primary" disabled>
                                <span id="recordIcon">üéôÔ∏è</span> Record (5s)
                            </button>
                            <div id="recordingStatus"></div>
                        </div>
                        <div class="progress mb-3" style="height: 30px;">
                            <div id="volumeMeter" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        Detection Results
                    </div>
                    <div class="card-body">
                        <h5>Voice Emotion:</h5>
                        <div class="mb-3">
                            <div class="emotion-indicator neutral-color" id="emotionIndicator"></div>
                            <span id="emotionText">Waiting for input...</span>
                            <span class="badge bg-secondary" id="confidenceText"></span>
                        </div>
                        
                        <h5>Text Sentiment:</h5>
                        <div class="mb-3">
                            <span id="sentimentText">Waiting for input...</span>
                            <span class="badge bg-secondary" id="sentimentScoreText"></span>
                        </div>
                        
                        <h5>Selected Tone:</h5>
                        <div class="mb-3">
                            <span id="toneText">Waiting for input...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Conversation
                    </div>
                    <div class="card-body">
                        <div class="chat-container" id="chatContainer">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-secondary" id="transcriptText">
                                Your speech will appear here...
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        AI Response
                    </div>
                    <div class="card-body">
                        <div class="alert alert-primary" id="aiResponseText">
                            AI responses will appear here...
                        </div>
                        <div class="d-flex justify-content-between">
                            <span id="voiceStatus">Voice synthesis: Not available</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        System Log
                    </div>
                    <div class="card-body">
                        <div class="alert alert-secondary" style="height: 150px; overflow-y: auto;" id="logContainer">
                            <!-- Log messages will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // Connect to Socket.IO server
        const socket = io();
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const systemStatus = document.getElementById('systemStatus');
        const recordingStatus = document.getElementById('recordingStatus');
        const volumeMeter = document.getElementById('volumeMeter');
        const emotionIndicator = document.getElementById('emotionIndicator');
        const emotionText = document.getElementById('emotionText');
        const confidenceText = document.getElementById('confidenceText');
        const sentimentText = document.getElementById('sentimentText');
        const sentimentScoreText = document.getElementById('sentimentScoreText');
        const toneText = document.getElementById('toneText');
        const transcriptText = document.getElementById('transcriptText');
        const aiResponseText = document.getElementById('aiResponseText');
        const voiceStatus = document.getElementById('voiceStatus');
        const chatContainer = document.getElementById('chatContainer');
        const logContainer = document.getElementById('logContainer');
        
        // Variables
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isSystemRunning = false;
        
        // Socket.IO events
        socket.on('connect', () => {
            addLogMessage('Connected to server');
        });
        
        socket.on('disconnect', () => {
            addLogMessage('Disconnected from server');
            updateSystemStatus(false);
        });
        
        socket.on('system_status', (data) => {
            updateSystemStatus(data.running);
        });
        
        socket.on('error', (data) => {
            addLogMessage(`Error: ${data.message}`);
        });
        
        socket.on('processing_result', (data) => {
            // Update UI with results
            updateEmotionDisplay(data.voice_emotion, data.voice_confidence);
            updateSentimentDisplay(data.text_sentiment, data.text_sentiment_score);
            updateToneDisplay(data.selected_tone);
            updateTranscript(data.transcript);
            updateAIResponse(data.ai_response, data.voice_synthesized);
            
            // Add to chat
            if (data.transcript && data.transcript !== "No speech detected") {
                addChatMessage('user', data.transcript);
                addChatMessage('ai', data.ai_response);
            }
            
            addLogMessage(`Processed audio: ${data.voice_emotion} (${data.voice_confidence.toFixed(2)}), "${data.transcript}"`);
        });
        
        // Button event listeners
        startBtn.addEventListener('click', () => {
            socket.emit('start_system');
            addLogMessage('Starting system...');
        });
        
        stopBtn.addEventListener('click', () => {
            socket.emit('stop_system');
            addLogMessage('Stopping system...');
        });
        
        recordBtn.addEventListener('click', () => {
            if (!isRecording) {
                startRecording();
            }
        });
        
        // Functions
        function updateSystemStatus(running) {
            isSystemRunning = running;
            
            if (running) {
                systemStatus.textContent = 'System is running and ready to process audio.';
                systemStatus.className = 'alert alert-success';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                recordBtn.disabled = false;
            } else {
                systemStatus.textContent = 'System is not running. Click "Start System" to begin.';
                systemStatus.className = 'alert alert-info';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                recordBtn.disabled = true;
            }
        }
        
        function updateEmotionDisplay(emotion, confidence) {
            emotionText.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
            confidenceText.textContent = `${(confidence * 100).toFixed(0)}%`;
            
            // Update emotion indicator color
            emotionIndicator.className = 'emotion-indicator';
            if (emotion === 'happy') {
                emotionIndicator.classList.add('happy-color');
            } else if (emotion === 'sad') {
                emotionIndicator.classList.add('sad-color');
            } else if (emotion === 'angry') {
                emotionIndicator.classList.add('angry-color');
            } else if (emotion === 'neutral') {
                emotionIndicator.classList.add('neutral-color');
            } else {
                emotionIndicator.classList.add('error-color');
            }
        }
        
        function updateSentimentDisplay(sentiment, score) {
            sentimentText.textContent = sentiment.charAt(0).toUpperCase() + sentiment.slice(1).replace('_', ' ');
            sentimentScoreText.textContent = score ? `${(score * 100).toFixed(0)}%` : '';
        }
        
        function updateToneDisplay(tone) {
            if (tone) {
                const toneStyle = tone.style.charAt(0).toUpperCase() + tone.style.slice(1);
                const toneRate = tone.rate.charAt(0).toUpperCase() + tone.rate.slice(1);
                const tonePitch = tone.pitch.charAt(0).toUpperCase() + tone.pitch.slice(1);
                
                toneText.innerHTML = `
                    <span class="tone-badge tone-${tone.style}">${toneStyle}</span>
                    <span class="badge bg-secondary">Rate: ${toneRate}</span>
                    <span class="badge bg-secondary">Pitch: ${tonePitch}</span>
                `;
            } else {
                toneText.textContent = 'Waiting for input...';
            }
        }
        
        function updateTranscript(transcript) {
            transcriptText.textContent = transcript || 'No speech detected';
        }
        
        function updateAIResponse(response, voiceSynthesized) {
            aiResponseText.textContent = response || 'Waiting for input...';
            
            if (voiceSynthesized) {
                voiceStatus.textContent = 'Voice synthesis: Completed';
                voiceStatus.className = 'text-success';
            } else {
                voiceStatus.textContent = 'Voice synthesis: Simulated (using fallback)';
                voiceStatus.className = 'text-warning';
            }
        }
        
        function addChatMessage(role, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user-message' : 'ai-message';
            messageDiv.textContent = message;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function addLogMessage(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function startRecording() {
            if (!isSystemRunning) return;
            
            // Reset audio chunks
            audioChunks = [];
            
            // Update UI
            isRecording = true;
            recordBtn.disabled = true;
            recordIcon.textContent = '‚è∫Ô∏è';
            recordingStatus.innerHTML = '<span class="recording-indicator"></span> Recording...';
            
            // Get user media with specific constraints for better audio quality
            navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 16000, // Whisper works best with 16kHz
                    channelCount: 1    // Mono audio for better speech recognition
                } 
            })
            .then(stream => {
                // Use specific MIME type for better compatibility
                const mimeType = 'audio/webm;codecs=opus';
                const options = { mimeType: mimeType, audioBitsPerSecond: 128000 };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                    addLogMessage('Using preferred audio format: ' + mimeType);
                } catch (e) {
                    // Fallback if the preferred format is not supported
                    mediaRecorder = new MediaRecorder(stream);
                    addLogMessage('Using fallback audio format: ' + mediaRecorder.mimeType);
                }
                
                // Request data more frequently for better quality
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    // Create audio blob with proper MIME type
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    
                    // Log audio size for debugging
                    const audioSizeMB = (audioBlob.size / (1024 * 1024)).toFixed(2);
                    addLogMessage(`Audio recorded: ${audioSizeMB} MB using ${mediaRecorder.mimeType}`);
                    
                    // Convert to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        
                        // Send to server
                        socket.emit('process_audio', { audio: base64Audio });
                        
                        // Update UI
                        isRecording = false;
                        recordBtn.disabled = false;
                        recordIcon.textContent = 'üéôÔ∏è';
                        recordingStatus.textContent = 'Processing...';
                        
                        addLogMessage('Audio recorded and sent for processing');
                    };
                };
                    
                    // Request data frequently (every 250ms) for better quality
                    mediaRecorder.start(250);
                    
                    // Set up audio analyzer for volume meter
                    const audioContext = new AudioContext();
                    const audioSource = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    analyser.fftSize = 512;  // Increased for better frequency resolution
                    audioSource.connect(analyser);
                    
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    // Log audio context state
                    addLogMessage(`Audio context state: ${audioContext.state}, sample rate: ${audioContext.sampleRate}Hz`);
                    
                    // Update volume meter
                    function updateVolumeMeter() {
                        if (!isRecording) return;
                        
                        analyser.getByteFrequencyData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i];
                        }
                        const average = sum / bufferLength;
                        const volume = Math.min(100, average * 2);
                        
                        volumeMeter.style.width = `${volume}%`;
                        
                        requestAnimationFrame(updateVolumeMeter);
                    }
                    
                    updateVolumeMeter();
                    
                    // Stop recording after 5 seconds
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            stream.getTracks().forEach(track => track.stop());
                        }
                    }, 5000);
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    addLogMessage(`Error accessing microphone: ${error.message}`);
                    
                    isRecording = false;
                    recordBtn.disabled = false;
                    recordIcon.textContent = 'üéôÔ∏è';
                    recordingStatus.textContent = '';
                });
        }
        
        // Add initial log message
        addLogMessage('Web interface loaded. Click "Start System" to begin.');
    </script>
</body>
</html>
